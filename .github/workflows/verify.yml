name: verify
on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

jobs:
  test-linux-cpu:
    runs-on: "linux.2xlarge"
    steps:
      - name: Enable SSH (Click me for details)
        uses: seemethere/add-github-ssh-key@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Sleep for ~60 seconds to allow the user to login
        run: |
          for num in $(seq 12); do
            echo "${num}"
            who
            sleep 5
          done
      - name: Sleep for ~30 minutes, kill on user logout
        timeout-minutes: 30
        run: |
          echo "Holding runner until all ssh sessions have logged out"
          while [[ "$(who)" != "" ]]; do
            echo "."
            sleep 5
          done
      - name: Kill active ssh sessions if still around (Useful if workflow was cancelled)
        if: always()
        run: |
          pkill --signal HUP sshd || true
